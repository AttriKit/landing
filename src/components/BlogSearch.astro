---
/**
 * BlogSearch Component
 * Search input with debounced filtering and keyboard shortcut
 */
---

<div class="blog-search">
  <div class="search-input-wrapper">
    <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
      <circle cx="11" cy="11" r="8"/>
      <path d="M21 21l-4.35-4.35"/>
    </svg>
    <input
      type="text"
      id="blog-search-input"
      class="search-input"
      placeholder="搜索文章..."
      aria-label="搜索文章"
    />
    <button
      id="search-clear"
      class="search-clear"
      aria-label="清除搜索"
      style="display: none;"
    >
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>
</div>

<style>
  .blog-search {
    margin-bottom: var(--spacing-10);
  }

  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    max-width: 600px;
    margin: 0 auto;
  }

  .search-icon {
    position: absolute;
    left: var(--spacing-4);
    color: var(--color-text-light);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-12);
    background: var(--color-bg-surface);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    font-family: var(--font-family-body);
    color: var(--color-text-primary);
    transition: all var(--transition-fast);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 0 3px var(--color-accent-subtle);
  }

  .search-input::placeholder {
    color: var(--color-text-light);
  }

  .search-clear {
    position: absolute;
    right: var(--spacing-3);
    background: none;
    border: none;
    color: var(--color-text-light);
    cursor: pointer;
    padding: var(--spacing-1);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }

  .search-clear:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text-secondary);
  }

  @media (max-width: 640px) {
    .search-input {
      padding: var(--spacing-3) var(--spacing-10);
      font-size: var(--font-size-sm);
    }
  }
</style>

<script define:vars={{ searchDebounceMs: 300 }}>
  const searchInput = document.getElementById('blog-search-input');
  const searchClear = document.getElementById('search-clear');
  const postCards = document.querySelectorAll('.post-card');

  let searchTimeout: ReturnType<typeof setTimeout>;

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase().trim();

    // Show/hide clear button
    if (query) {
      searchClear!.style.display = 'flex';
    } else {
      searchClear!.style.display = 'none';
    }

    // Debounce search
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      filterPosts(query);
    }, searchDebounceMs);
  });

  searchClear?.addEventListener('click', () => {
    searchInput!.value = '';
    searchClear!.style.display = 'none';
    filterPosts('');
    searchInput!.focus();

    // Trigger tag filter reset event
    window.dispatchEvent(new CustomEvent('blog-search-cleared'));
  });

  function filterPosts(query: string) {
    postCards.forEach(card => {
      if (!query) {
        (card as HTMLElement).style.display = '';
        return;
      }

      const title = card.querySelector('.post-title')?.textContent?.toLowerCase() || '';
      const description = card.querySelector('.post-description')?.textContent?.toLowerCase() || '';
      const tags = Array.from(card.querySelectorAll('.tag-badge'))
        .map(tag => tag.textContent?.toLowerCase() || '')
        .join(' ');

      const matches = title.includes(query) ||
                     description.includes(query) ||
                     tags.includes(query);

      (card as HTMLElement).style.display = matches ? '' : 'none';
    });

    // Trigger event for no results handling
    window.dispatchEvent(new CustomEvent('blog-posts-filtered', {
      detail: { visibleCount: Array.from(postCards).filter(c => (c as HTMLElement).style.display !== 'none').length }
    }));
  }

  // Keyboard shortcut: Cmd/Ctrl + K to focus search
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      searchInput?.focus();
    }
  });
</script>
