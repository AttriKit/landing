---
/**
 * Pagefind search component with modal-first interaction
 * @param {string} type - Search type: 'blog' or 'docs'
 * @param {string} placeholder - Trigger input placeholder text
 * @param {string} resultLabel - Label for results count (e.g., '篇文章', '篇文档')
 * @param {string} scope - Unique scope for multiple instances (e.g., 'sidebar', 'main')
 */
const { type = 'blog', placeholder, resultLabel = '篇文章', scope = '' } = Astro.props;

// Default placeholders
const placeholders = {
  blog: '搜索文章...',
  docs: '搜索文档...'
};

const triggerPlaceholder = placeholder || placeholders[type];
const resultCountLabel = resultLabel;

// Generate unique ID for each instance
const instanceId = scope ? `${type}-${scope}` : `${type}-${Math.random().toString(36).substr(2, 9)}`;
---

<!-- Search Trigger -->
<div class="search-trigger-container">
  <div class="search-trigger" id={`search-trigger-${instanceId}`} role="button" tabIndex={0} aria-label="打开搜索">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="search-icon">
      <circle cx="11" cy="11" r="8"/>
      <path d="M21 21l-4.35-4.35"/>
    </svg>
    <span class="search-trigger-placeholder">{triggerPlaceholder}</span>
    <span class="search-trigger-hint">⌘K</span>
  </div>
</div>

<!-- Search Modal -->
<div id={`search-modal-${instanceId}`} class="search-modal" aria-hidden="true">
  <div class="search-modal-overlay" id={`search-modal-overlay-${instanceId}`} aria-hidden="true" style="position: fixed; inset: 0; z-index: 1299;"></div>
  <div class="search-modal-content" role="dialog" aria-modal="true">
    <div class="search-modal-header">
      <div class="search-input-wrapper">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="search-icon">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        <input
          type="text"
          id={`search-input-${instanceId}`}
          placeholder={triggerPlaceholder}
          class="search-input"
          autocomplete="off"
        />
        <button id={`clear-search-${instanceId}`} class="clear-btn" aria-label="清除搜索" style="display: none;">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
    <div id={`search-results-${instanceId}`} class="search-results-list"></div>
    <div class="search-modal-footer">
      <span class="search-hints">
        <span class="search-hint"><kbd>↑↓</kbd> 导航</span>
        <span class="search-hint"><kbd>↵</kbd> 选择</span>
        <span class="search-hint"><kbd>ESC</kbd> 关闭</span>
      </span>
    </div>
  </div>
</div>

<script is:inline define:vars={{ instanceId, type, resultCountLabel }}>
  (function() {
    const searchId = instanceId;
    const searchType = type;
    const resultLabel = resultCountLabel;

    const searchTrigger = document.getElementById(`search-trigger-${searchId}`);
    const searchModal = document.getElementById(`search-modal-${searchId}`);
    const modalOverlay = document.getElementById(`search-modal-overlay-${searchId}`);
    const searchInput = document.getElementById(`search-input-${searchId}`);
    const clearBtn = document.getElementById(`clear-search-${searchId}`);
    const resultsContainer = document.getElementById(`search-results-${searchId}`);

    let pagefind = null;
    let selectedIndex = -1;
    let resultsList = [];

    // Load Pagefind API
    async function loadPagefind() {
      try {
        const module = await import('/pagefind/pagefind.js');
        pagefind = module.default || module;
        return pagefind;
      } catch (e) {
        console.warn('Pagefind not available. Search will work after build.');
        return null;
      }
    }

    // Open modal
    function openModal() {
      if (searchModal) {
        // Move modal to body to avoid stacking context issues
        document.body.appendChild(searchModal);
        searchModal.style.display = 'flex';
        searchModal.setAttribute('data-open', 'true');
        searchModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        // Focus input after modal opens
        setTimeout(() => searchInput?.focus(), 100);
      }
    }

    // Close modal
    function closeModal() {
      if (searchModal) {
        searchModal.setAttribute('data-open', 'false');
        searchModal.setAttribute('aria-hidden', 'true');
        // Wait for animation to complete before hiding
        setTimeout(() => {
          if (searchModal?.getAttribute('data-open') === 'false') {
            searchModal.style.display = 'none';
          }
        }, 300);
        document.body.style.overflow = '';
        // Clear search
        if (searchInput) searchInput.value = '';
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (clearBtn) clearBtn.style.display = 'none';
        selectedIndex = -1;
        resultsList = [];
      }
    }

    // Perform search with filter
    const performSearch = async (query) => {
      const normalizedQuery = query.trim();

      if (!normalizedQuery) {
        // Clear results when query is empty
        if (clearBtn) clearBtn.style.display = 'none';
        if (resultsContainer) resultsContainer.innerHTML = '';
        selectedIndex = -1;
        resultsList = [];
        return;
      }

      // Load Pagefind if not loaded
      if (!pagefind) {
        pagefind = await loadPagefind();
      }

      if (!pagefind) {
        if (resultsContainer) {
          resultsContainer.innerHTML = `
            <div class="search-empty-state">
              <p>搜索功能在构建后可用</p>
            </div>
          `;
        }
        return;
      }

      if (clearBtn) clearBtn.style.display = 'flex';

      // Search with Pagefind and filter
      const results = await pagefind.search(normalizedQuery, {
        filters: { type: searchType }
      });

      if (results.results.length === 0) {
        if (resultsContainer) {
          resultsContainer.innerHTML = `<div class="search-no-results">未找到匹配的${resultLabel.replace('篇', '')}</div>`;
        }
        selectedIndex = -1;
        resultsList = [];
        return;
      }

      // Load and display results
      const resultData = await Promise.all(
        results.results.slice(0, 20).map(r => r.data())
      );

      resultsList = resultData;
      selectedIndex = -1;

      if (resultsContainer) {
        resultsContainer.innerHTML = resultData.map((result, index) => {
          const title = result.meta.title || '';
          const excerpt = result.excerpt || '';
          return `
            <a href="${result.url}" class="search-result-item" data-index="${index}">
              <div class="search-result-item-content">
                <h4 class="search-result-item-title">${escapeHtml(title)}</h4>
                ${excerpt ? `<p class="search-result-item-excerpt">${escapeHtml(excerpt)}</p>` : ''}
              </div>
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="search-result-arrow">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          `;
        }).join('');
      }
    };

    // Update selection
    function updateSelection() {
      const items = resultsContainer?.querySelectorAll('.search-result-item');
      items?.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Debounced search
    const debouncedSearch = debounce((query) => {
      performSearch(query);
    }, 300);

    // Event listeners
    searchTrigger?.addEventListener('click', openModal);
    searchTrigger?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openModal();
      }
    });

    modalOverlay?.addEventListener('click', closeModal);

    searchInput?.addEventListener('input', (e) => {
      debouncedSearch(e.target.value);
    });

    clearBtn?.addEventListener('click', () => {
      searchInput.value = '';
      performSearch('');
      searchInput.focus();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K to open search
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (searchModal && searchModal.getAttribute('data-open') === 'true') {
          closeModal();
        } else {
          openModal();
        }
        return;
      }

      // If modal is not open, don't handle other keys
      if (!searchModal || searchModal.getAttribute('data-open') !== 'true') return;

      // Escape to close modal
      if (e.key === 'Escape') {
        e.preventDefault();
        closeModal();
        return;
      }

      // Arrow keys for navigation
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        const items = resultsContainer?.querySelectorAll('.search-result-item');
        if (!items || items.length === 0) return;

        if (e.key === 'ArrowDown') {
          selectedIndex = selectedIndex < items.length - 1 ? selectedIndex + 1 : 0;
        } else {
          selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : items.length - 1;
        }

        updateSelection();
        return;
      }

      // Enter to select
      if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const selectedItem = resultsContainer?.querySelector(`[data-index="${selectedIndex}"]`);
        if (selectedItem) {
          selectedItem.click();
        }
        return;
      }
    });

    // Close modal when clicking a result
    resultsContainer?.addEventListener('click', (e) => {
      const link = e.target.closest('.search-result-item');
      if (link) {
        closeModal();
      }
    });

    // Focus input when clicking on modal content
    searchModal?.querySelector('.search-modal-content')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        searchInput?.focus();
      }
    });
  })();
</script>

<style>
  /* ============================================
     Search Trigger - Enhanced with subtle depth
     ============================================ */
  .search-trigger-container {
    max-width: 640px;
  }

  .search-trigger {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    background: var(--color-bg-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-2) var(--spacing-3);
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-sm);
  }

  .search-trigger:hover {
    border-color: var(--color-border-hover);
    background: var(--color-bg-surface);
  }

  .search-trigger:focus-visible {
    outline: none;
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.15);
  }

  .search-trigger .search-icon {
    flex-shrink: 0;
    color: var(--color-accent-primary);
  }

  .search-trigger-placeholder {
    flex: 1;
    color: var(--color-text-muted);
    font-size: var(--font-size-base);
    font-weight: 500;
  }

  .search-trigger-hint {
    flex-shrink: 0;
    font-size: var(--font-size-xs);
    color: var(--color-accent-primary);
    background: var(--color-accent-subtle);
    padding: 4px 8px;
    border-radius: var(--radius-md);
    font-family: var(--font-family-display);
    font-weight: 600;
    letter-spacing: 0.02em;
    border: 1px solid rgba(10, 95, 143, 0.1);
  }

  /* ============================================
     Search Modal - Premium feel with smooth animations
     ============================================ */
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: var(--z-modal);
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .search-modal[data-open="true"] {
    opacity: 1;
    pointer-events: auto;
  }

  .search-modal-overlay {
    background: rgba(26, 31, 44, 0.7);
    backdrop-filter: blur(8px);
    transition: background 0.25s ease;
  }

  .search-modal-content {
    position: relative;
    z-index: calc(var(--z-modal) + 1);
    margin-top: 12vh;
    align-self: center;
    width: 100%;
    max-width: 680px;
    max-height: 75vh;
    background: var(--color-bg-surface);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-2xl),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
    display: flex;
    flex-direction: column;
    transform: scale(0.96) translateY(8px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .search-modal[data-open="true"] .search-modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
  }

  /* ============================================
     Modal Header - Clean input area
     ============================================ */
  .search-modal-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-5) var(--spacing-6);
    border-bottom: 1px solid var(--color-border);
  }

  .search-input-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    background: var(--color-bg-secondary);
    border: 1.5px solid transparent;
    border-radius: var(--radius-lg);
    padding: var(--spacing-3) var(--spacing-4);
    transition: all var(--transition-fast);
  }

  .search-input-wrapper:focus-within {
    background: var(--color-bg-surface);
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.1);
  }

  .search-input-wrapper .search-icon {
    flex-shrink: 0;
    color: var(--color-accent-primary);
  }

  .search-input-wrapper .search-input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: var(--font-size-base);
    font-weight: 500;
    color: var(--color-text-primary);
    font-family: var(--font-family-body);
    min-width: 0;
  }

  .search-input-wrapper .search-input::placeholder {
    color: var(--color-text-light);
    font-weight: 400;
  }

  .search-input-wrapper .clear-btn {
    flex-shrink: 0;
    display: none;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--color-bg-secondary);
    border: none;
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .search-input-wrapper .clear-btn:hover {
    background: var(--color-error-bg);
    color: var(--color-error);
  }

  .search-input-wrapper .clear-btn[style*="flex"] {
    display: flex;
  }

  /* ============================================
     Search Results List - Smooth scrolling
     ============================================ */
  .search-results-list {
    overflow-y: auto;
    padding: var(--spacing-4);
    flex: 1;
    min-height: 0;
  }

  /* Hide when empty */
  .search-results-list:empty {
    display: none;
  }

  /* No results message */
  .search-no-results {
    padding: var(--spacing-8);
    text-align: center;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
  }

  /* Custom scrollbar - refined */
  .search-results-list::-webkit-scrollbar {
    width: 8px;
  }

  .search-results-list::-webkit-scrollbar-track {
    background: transparent;
    margin: var(--spacing-2);
  }

  .search-results-list::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
    transition: background var(--transition-fast);
  }

  .search-results-list::-webkit-scrollbar-thumb:hover {
    background: var(--color-border-hover);
  }

  /* ============================================
     Search Result Item - Card-style design
     ============================================ */
  .search-result-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-4);
    padding: var(--spacing-5);
    background: var(--color-bg-surface);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-xl);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-fast);
    margin-bottom: var(--spacing-3);
    position: relative;
    overflow: hidden;
  }

  /* Subtle border glow on hover */
  .search-result-item::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: var(--radius-xl);
    padding: 1.5px;
    background: linear-gradient(135deg,
      var(--color-accent-primary),
      var(--color-accent-secondary)
    );
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .search-result-item:hover::after,
  .search-result-item.selected::after {
    opacity: 1;
  }

  .search-result-item:hover,
  .search-result-item.selected {
    background: linear-gradient(135deg,
      rgba(10, 95, 143, 0.02) 0%,
      rgba(0, 180, 166, 0.02) 100%
    );
    border-color: transparent;
    transform: translateX(4px);
  }

  .search-result-item:last-child {
    margin-bottom: 0;
  }

  .search-result-item-content {
    flex: 1;
    min-width: 0;
  }

  .search-result-item-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    font-family: var(--font-family-display);
    color: var(--color-text-primary);
    margin: 0 0 var(--spacing-2) 0;
    line-height: 1.4;
    letter-spacing: -0.01em;
  }

  .search-result-item-excerpt {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin: 0;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-result-arrow {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    color: var(--color-text-light);
    margin-top: 2px;
    transition: all var(--transition-fast);
    opacity: 0.5;
  }

  .search-result-item:hover .search-result-arrow,
  .search-result-item.selected .search-result-arrow {
    transform: translateX(4px);
    color: var(--color-accent-secondary);
    opacity: 1;
  }

  /* Staggered animation for results */
  .search-result-item {
    animation: resultSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) both;
  }

  .search-result-item:nth-child(1) { animation-delay: 0.05s; }
  .search-result-item:nth-child(2) { animation-delay: 0.08s; }
  .search-result-item:nth-child(3) { animation-delay: 0.11s; }
  .search-result-item:nth-child(4) { animation-delay: 0.14s; }
  .search-result-item:nth-child(5) { animation-delay: 0.17s; }

  /* ============================================
     Modal Footer - Keyboard shortcuts
     ============================================ */
  .search-modal-footer {
    display: flex;
    justify-content: center;
    padding: var(--spacing-4) var(--spacing-6);
    border-top: 1px solid var(--color-border);
    background: var(--color-bg-secondary);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  }

  .search-hints {
    display: flex;
    gap: var(--spacing-6);
    font-size: var(--font-size-xs);
    color: var(--color-text-light);
  }

  .search-hint {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .search-hint kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    height: 20px;
    padding: 0 6px;
    background: var(--color-bg-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: var(--font-family-display);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.02em;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  /* ============================================
     Responsive Styles
     ============================================ */
  @media (max-width: 768px) {
    .search-modal {
      padding: 0;
    }

    .search-modal-content {
      margin: 0;
      max-height: 100vh;
      max-width: 100%;
      border-radius: 0;
      transform: translateY(100%);
    }

    .search-modal[data-open="true"] .search-modal-content {
      transform: translateY(0);
    }

    .search-modal-footer {
      border-radius: 0;
    }

    .search-trigger {
      padding: var(--spacing-3) var(--spacing-4);
    }

    .search-trigger-placeholder {
      font-size: var(--font-size-sm);
    }

    .search-trigger-hint {
      padding: 3px 6px;
      font-size: 10px;
    }

    .search-modal-header {
      padding: var(--spacing-4) var(--spacing-5);
    }

    .search-results-list {
      padding: var(--spacing-3);
    }

    .search-result-item {
      padding: var(--spacing-4);
      margin-bottom: var(--spacing-2);
    }

    .search-result-item:hover,
    .search-result-item.selected {
      transform: none;
    }

    .search-hints {
      gap: var(--spacing-4);
      flex-wrap: wrap;
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .search-modal-header {
      gap: var(--spacing-2);
    }

    .search-result-item {
      gap: var(--spacing-3);
      padding: var(--spacing-3) var(--spacing-4);
    }
  }

  /* ============================================
     Animations
     ============================================ */
  @keyframes resultSlideIn {
    from {
      opacity: 0;
      transform: translateX(-12px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>
