---
/**
 * Pagefind search component with modal-first interaction
 * @param {string} type - Search type: 'blog' or 'docs'
 * @param {string} placeholder - Trigger input placeholder text
 * @param {string} resultLabel - Label for results count (e.g., '篇文章', '篇文档')
 */
const { type = 'blog', placeholder, resultLabel = '篇文章' } = Astro.props;

// Default placeholders
const placeholders = {
  blog: '搜索文章...',
  docs: '搜索文档...'
};

const triggerPlaceholder = placeholder || placeholders[type];
const resultCountLabel = resultLabel;
---

<!-- Search Trigger -->
<div class="search-trigger-container">
  <div class="search-trigger" id={`search-trigger-${type}`} role="button" tabIndex={0} aria-label="打开搜索">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="search-icon">
      <circle cx="11" cy="11" r="8"/>
      <path d="M21 21l-4.35-4.35"/>
    </svg>
    <span class="search-trigger-placeholder">{triggerPlaceholder}</span>
    <span class="search-trigger-hint">⌘K</span>
  </div>
</div>

<!-- Search Modal -->
<div id={`search-modal-${type}`} class="search-modal" style="display: none;" aria-hidden="true">
  <div class="search-modal-overlay" id={`search-modal-overlay-${type}`} aria-hidden="true"></div>
  <div class="search-modal-content" role="dialog" aria-modal="true">
    <div class="search-modal-header">
      <div class="search-input-wrapper">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="search-icon">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        <input
          type="text"
          id={`search-input-${type}`}
          placeholder={triggerPlaceholder}
          class="search-input"
          autocomplete="off"
        />
        <button id={`clear-search-${type}`} class="clear-btn" aria-label="清除搜索" style="display: none;">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <button id={`close-modal-${type}`} class="modal-close-btn" aria-label="关闭搜索">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        <span>ESC</span>
      </button>
    </div>
    <div id={`search-results-${type}`} class="search-results-list"></div>
    <div class="search-modal-footer">
      <span class="search-hints">
        <span class="search-hint"><kbd>↑↓</kbd> 导航</span>
        <span class="search-hint"><kbd>↵</kbd> 选择</span>
        <span class="search-hint"><kbd>ESC</kbd> 关闭</span>
      </span>
    </div>
  </div>
</div>

<script is:inline define:vars={{ type, resultCountLabel }}>
  (function() {
    const searchType = type;
    const resultLabel = resultCountLabel;

    const searchTrigger = document.getElementById(`search-trigger-${searchType}`);
    const searchModal = document.getElementById(`search-modal-${searchType}`);
    const modalOverlay = document.getElementById(`search-modal-overlay-${searchType}`);
    const closeModalBtn = document.getElementById(`close-modal-${searchType}`);
    const searchInput = document.getElementById(`search-input-${searchType}`);
    const clearBtn = document.getElementById(`clear-search-${searchType}`);
    const resultsContainer = document.getElementById(`search-results-${searchType}`);

    let pagefind = null;
    let selectedIndex = -1;
    let resultsList = [];

    // Load Pagefind API
    async function loadPagefind() {
      try {
        const module = await import('/pagefind/pagefind.js');
        pagefind = module.default || module;
        return pagefind;
      } catch (e) {
        console.warn('Pagefind not available. Search will work after build.');
        return null;
      }
    }

    // Open modal
    function openModal() {
      if (searchModal) {
        searchModal.style.display = 'flex';
        searchModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        // Focus input after modal opens
        setTimeout(() => searchInput?.focus(), 100);
      }
    }

    // Close modal
    function closeModal() {
      if (searchModal) {
        searchModal.style.display = 'none';
        searchModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        // Clear search
        if (searchInput) searchInput.value = '';
        if (resultsContainer) {
          resultsContainer.innerHTML = `
            <div class="search-empty-state">
              <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <p>输入关键词开始搜索</p>
              <span>支持模糊搜索和内容匹配</span>
            </div>
          `;
        }
        if (clearBtn) clearBtn.style.display = 'none';
        selectedIndex = -1;
        resultsList = [];
      }
    }

    // Perform search with filter
    const performSearch = async (query) => {
      const normalizedQuery = query.trim();

      if (!normalizedQuery) {
        // Show empty state
        if (clearBtn) clearBtn.style.display = 'none';
        if (resultsContainer) {
          resultsContainer.innerHTML = `
            <div class="search-empty-state">
              <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <p>输入关键词开始搜索</p>
              <span>支持模糊搜索和内容匹配</span>
            </div>
          `;
        }
        selectedIndex = -1;
        resultsList = [];
        return;
      }

      // Load Pagefind if not loaded
      if (!pagefind) {
        pagefind = await loadPagefind();
      }

      if (!pagefind) {
        if (resultsContainer) {
          resultsContainer.innerHTML = `
            <div class="search-empty-state">
              <p>搜索功能在构建后可用</p>
            </div>
          `;
        }
        return;
      }

      if (clearBtn) clearBtn.style.display = 'flex';

      // Search with Pagefind and filter
      const results = await pagefind.search(normalizedQuery, {
        filters: { type: searchType }
      });

      if (results.results.length === 0) {
        if (resultsContainer) {
          resultsContainer.innerHTML = `
            <div class="search-empty-state">
              <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
                <line x1="8" y1="11" x2="14" y2="11"/>
              </svg>
              <p>未找到匹配的${resultLabel.replace('篇', '')}</p>
              <span>尝试其他关键词</span>
            </div>
          `;
        }
        selectedIndex = -1;
        resultsList = [];
        return;
      }

      // Load and display results
      const resultData = await Promise.all(
        results.results.slice(0, 20).map(r => r.data())
      );

      resultsList = resultData;
      selectedIndex = -1;

      if (resultsContainer) {
        resultsContainer.innerHTML = resultData.map((result, index) => {
          const title = result.meta.title || '';
          const excerpt = result.excerpt || '';
          return `
            <a href="${result.url}" class="search-result-item" data-index="${index}">
              <div class="search-result-item-content">
                <h4 class="search-result-item-title">${escapeHtml(title)}</h4>
                ${excerpt ? `<p class="search-result-item-excerpt">${escapeHtml(excerpt)}</p>` : ''}
              </div>
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="search-result-arrow">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          `;
        }).join('');
      }
    };

    // Update selection
    function updateSelection() {
      const items = resultsContainer?.querySelectorAll('.search-result-item');
      items?.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Debounced search
    const debouncedSearch = debounce((query) => {
      performSearch(query);
    }, 300);

    // Event listeners
    searchTrigger?.addEventListener('click', openModal);
    searchTrigger?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openModal();
      }
    });

    closeModalBtn?.addEventListener('click', closeModal);
    modalOverlay?.addEventListener('click', closeModal);

    searchInput?.addEventListener('input', (e) => {
      debouncedSearch(e.target.value);
    });

    clearBtn?.addEventListener('click', () => {
      searchInput.value = '';
      performSearch('');
      searchInput.focus();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K to open search
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (searchModal && searchModal.style.display === 'flex') {
          closeModal();
        } else {
          openModal();
        }
        return;
      }

      // If modal is not open, don't handle other keys
      if (!searchModal || searchModal.style.display !== 'flex') return;

      // Escape to close modal
      if (e.key === 'Escape') {
        e.preventDefault();
        closeModal();
        return;
      }

      // Arrow keys for navigation
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        const items = resultsContainer?.querySelectorAll('.search-result-item');
        if (!items || items.length === 0) return;

        if (e.key === 'ArrowDown') {
          selectedIndex = selectedIndex < items.length - 1 ? selectedIndex + 1 : 0;
        } else {
          selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : items.length - 1;
        }

        updateSelection();
        return;
      }

      // Enter to select
      if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const selectedItem = resultsContainer?.querySelector(`[data-index="${selectedIndex}"]`);
        if (selectedItem) {
          selectedItem.click();
        }
        return;
      }
    });

    // Close modal when clicking a result
    resultsContainer?.addEventListener('click', (e) => {
      const link = e.target.closest('.search-result-item');
      if (link) {
        closeModal();
      }
    });

    // Focus input when clicking on modal content
    searchModal?.querySelector('.search-modal-content')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        searchInput?.focus();
      }
    });
  })();
</script>

<style>
  /* Search Trigger */
  .search-trigger-container {
    max-width: 640px;
    margin: 0 auto var(--spacing-12);
    animation: fadeUp var(--transition-base) ease 0.2s both;
  }

  .search-trigger {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    background: var(--color-bg-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-3) var(--spacing-4);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .search-trigger:hover {
    border-color: var(--color-border-hover);
    background: var(--color-bg-secondary);
  }

  .search-trigger:focus-visible {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.12);
  }

  .search-trigger .search-icon {
    flex-shrink: 0;
    color: var(--color-text-muted);
  }

  .search-trigger-placeholder {
    flex: 1;
    color: var(--color-text-muted);
    font-size: var(--font-size-base);
  }

  .search-trigger-hint {
    flex-shrink: 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
    background: var(--color-bg-secondary);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-family: var(--font-family-display);
  }

  /* Search Modal */
  .search-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding-top: 15vh;
  }

  .search-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
  }

  .search-modal-content {
    position: relative;
    width: 100%;
    max-width: 640px;
    max-height: 70vh;
    background: var(--color-bg-surface);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-2xl);
    display: flex;
    flex-direction: column;
    animation: modalIn var(--transition-base) ease;
  }

  /* Modal Header */
  .search-modal-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-4) var(--spacing-5);
    border-bottom: 1px solid var(--color-border);
  }

  .search-input-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-2) var(--spacing-3);
  }

  .search-input-wrapper:focus-within {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.12);
  }

  .search-input-wrapper .search-icon {
    flex-shrink: 0;
    color: var(--color-text-muted);
  }

  .search-input-wrapper .search-input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: var(--font-size-base);
    color: var(--color-text-primary);
    font-family: var(--font-family-body);
    min-width: 0;
  }

  .search-input-wrapper .search-input::placeholder {
    color: var(--color-text-light);
  }

  .search-input-wrapper .clear-btn {
    flex-shrink: 0;
    display: none;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .search-input-wrapper .clear-btn:hover {
    background: var(--color-bg-surface);
    color: var(--color-text-primary);
  }

  .search-input-wrapper .clear-btn[style*="flex"] {
    display: flex;
  }

  .modal-close-btn {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-3);
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--font-size-sm);
    font-family: var(--font-family-display);
  }

  .modal-close-btn:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
  }

  /* Search Results List */
  .search-results-list {
    overflow-y: auto;
    padding: var(--spacing-3);
    flex: 1;
    min-height: 200px;
  }

  .search-results-list::-webkit-scrollbar {
    width: 6px;
  }

  .search-results-list::-webkit-scrollbar-track {
    background: transparent;
  }

  .search-results-list::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
  }

  .search-results-list::-webkit-scrollbar-thumb:hover {
    background: var(--color-border-hover);
  }

  /* Search Result Item */
  .search-result-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-3);
    padding: var(--spacing-4);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-fast);
    margin-bottom: var(--spacing-2);
  }

  .search-result-item:hover,
  .search-result-item.selected {
    background: var(--color-bg-secondary);
    border-color: var(--color-primary);
  }

  .search-result-item:last-child {
    margin-bottom: 0;
  }

  .search-result-item-content {
    flex: 1;
    min-width: 0;
  }

  .search-result-item-title {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0 0 var(--spacing-1) 0;
    line-height: 1.4;
  }

  .search-result-item-excerpt {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin: 0;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-result-arrow {
    flex-shrink: 0;
    color: var(--color-text-light);
    margin-top: 2px;
    transition: transform var(--transition-fast);
  }

  .search-result-item:hover .search-result-arrow,
  .search-result-item.selected .search-result-arrow {
    transform: translateX(2px);
    color: var(--color-primary);
  }

  /* Empty State */
  .search-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-16) var(--spacing-8);
    text-align: center;
  }

  .search-empty-state svg {
    color: var(--color-text-light);
    margin-bottom: var(--spacing-4);
    opacity: 0.5;
  }

  .search-empty-state p {
    font-size: var(--font-size-base);
    font-weight: 500;
    color: var(--color-text-secondary);
    margin: 0 0 var(--spacing-1) 0;
  }

  .search-empty-state span {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  /* Modal Footer */
  .search-modal-footer {
    display: flex;
    justify-content: center;
    padding: var(--spacing-3) var(--spacing-5);
    border-top: 1px solid var(--color-border);
  }

  .search-hints {
    display: flex;
    gap: var(--spacing-6);
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
  }

  .search-hint {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .search-hint kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 22px;
    padding: 0 6px;
    background: var(--color-bg-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: var(--font-family-display);
    font-size: 11px;
    font-weight: 500;
  }

  /* Responsive Styles */
  @media (max-width: 768px) {
    .search-modal {
      padding-top: 10vh;
      padding-left: var(--spacing-4);
      padding-right: var(--spacing-4);
    }

    .search-modal-content {
      max-height: 80vh;
    }

    .search-trigger {
      padding: var(--spacing-2) var(--spacing-3);
    }

    .search-trigger-placeholder {
      font-size: var(--font-size-sm);
    }

    .search-trigger-hint {
      display: none;
    }

    .search-modal-header {
      padding: var(--spacing-3) var(--spacing-4);
    }

    .search-results-list {
      padding: var(--spacing-2);
    }

    .search-result-item {
      padding: var(--spacing-3);
    }

    .search-hints {
      gap: var(--spacing-4);
    }
  }

  @media (max-width: 480px) {
    .search-modal-content {
      border-radius: var(--radius-lg);
    }

    .modal-close-btn span {
      display: none;
    }
  }

  /* Animations */
  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes modalIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>
